import{r as S,c as b,L as Q,R as ce,E as t,d as de,x as fe,a as pe,g as j,l,m as a,k as n,u as s,f as D,v as M,e as g,o as y,S as K,p as _,q as R,F as ge,G as ve,T as we,U as me,N as ye,A as q,i as Ae}from"./index-aa3933e3.js";function _e(){const w=S({isRunning:!1,pid:null,retryCount:0,config:null}),c=S(!1),u=S(!1),d=S(null),k=b(()=>w.value.isRunning),T=b(()=>!!w.value.error),U=b(()=>!k.value&&!c.value),N=b(()=>k.value&&!u.value),$=b(()=>!c.value&&!u.value),v=b(()=>typeof window<"u"&&window.electronAPI&&window.electronAPI.aria2);async function p(){if(!v.value){console.warn("Electron API not available");return}try{const r=await window.electronAPI.aria2.getStatus();w.value=r}catch(r){console.error("获取 Aria2 状态失败:",r),w.value.error=r instanceof Error?r.message:String(r)}}async function F(){if(!v.value)return t.error("Electron 环境不可用"),!1;if(c.value)return t.warning("Aria2 正在启动中，请稍候"),!1;c.value=!0;try{const r=await window.electronAPI.aria2.start();return r.success?(await p(),!0):(t.error(`启动 Aria2 失败: ${r.error}`),!1)}catch(r){const f=r instanceof Error?r.message:String(r);return t.error(`启动 Aria2 失败: ${f}`),console.error("启动 Aria2 失败:",r),!1}finally{c.value=!1}}async function z(){if(!v.value)return t.error("Electron 环境不可用"),!1;if(u.value)return t.warning("Aria2 正在停止中，请稍候"),!1;u.value=!0;try{const r=await window.electronAPI.aria2.stop();return r.success?(t.success("Aria2 已停止"),await p(),!0):(t.error(`停止 Aria2 失败: ${r.error}`),!1)}catch(r){const f=r instanceof Error?r.message:String(r);return t.error(`停止 Aria2 失败: ${f}`),console.error("停止 Aria2 失败:",r),!1}finally{u.value=!1}}async function B(){if(!v.value)return t.error("Electron 环境不可用"),!1;if(c.value||u.value)return t.warning("Aria2 正在操作中，请稍候"),!1;c.value=!0;try{const r=await window.electronAPI.aria2.restart();return r.success?(t.success("Aria2 重启成功"),await p(),!0):(t.error(`重启 Aria2 失败: ${r.error}`),!1)}catch(r){const f=r instanceof Error?r.message:String(r);return t.error(`重启 Aria2 失败: ${f}`),console.error("重启 Aria2 失败:",r),!1}finally{c.value=!1}}async function I(r){if(!v.value)return t.error("Electron 环境不可用"),!1;try{const f={port:r.port,secret:r.secret,downloadDir:r.downloadDir,autoStart:r.autoStart,logLevel:r.logLevel},A=await window.electronAPI.aria2.updateConfig(f);return A.success?(await p(),!0):(t.error(`更新 Aria2 配置失败: ${A.error}`),!1)}catch(f){const A=f instanceof Error?f.message:String(f);return t.error(`更新 Aria2 配置失败: ${A}`),console.error("更新 Aria2 配置失败:",f),!1}}function x(r=5e3){d.value&&clearInterval(d.value),d.value=setInterval(async()=>{await p()},r)}function E(){d.value&&(clearInterval(d.value),d.value=null)}const P=b(()=>w.value.config?{host:"localhost",port:w.value.config.port,protocol:"http",secret:w.value.config.secret}:{host:"localhost",port:6800,protocol:"http",secret:""});return Q(async()=>{v.value&&(await p(),x())}),ce(()=>{E()}),{processInfo:w,isRunning:k,hasError:T,canStart:U,canStop:N,canRestart:$,isStarting:c,isStopping:u,isElectronAvailable:v,start:F,stop:z,restart:B,getStatus:p,updateConfig:I,startStatusCheck:x,stopStatusCheck:E,getConnectionConfig:P}}const Se={class:"aria2-local-service"},Ce={class:"card-header"},be={class:"status-content"},De={class:"status-row"},ke={key:0,class:"status-row"},Ie={class:"control-buttons"},xe={key:0},Ee=de({__name:"Aria2LocalService",setup(w){const c=fe(),{processInfo:u,isRunning:d,hasError:k,canStart:T,canStop:U,canRestart:N,isStarting:$,isStopping:v,isElectronAvailable:p,start:F,stop:z,restart:B,getStatus:I,updateConfig:x,getConnectionConfig:E}=_e(),P=S(),r=S(!1),f=S(!1),A=S(!1),i=pe({port:0,secret:"",downloadDir:"",autoStart:!1}),X={port:[{type:"number",min:1024,max:65535,message:"端口号必须在 1024-65535 之间",trigger:"blur"}]};async function Y(){r.value=!0;try{await I(),O(),t.success("状态已刷新")}catch{t.error("刷新状态失败")}finally{r.value=!1}}async function Z(){await F()&&(O(),t.success("Aria2 服务已启动"))}async function ee(){try{await q.confirm("确定要停止 Aria2 服务吗？这将中断所有正在进行的下载。","确认停止",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await z()}catch{}}async function re(){try{await q.confirm("确定要重启 Aria2 服务吗？这将暂时中断所有正在进行的下载。","确认重启",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await B()}catch{}}async function te(){if(!window.electronAPI){t.error("此功能仅在桌面应用中可用");return}try{const o=await window.electronAPI.showOpenDialog({title:"选择下载目录",properties:["openDirectory"],defaultPath:i.downloadDir});!o.canceled&&o.filePaths.length>0&&(i.downloadDir=o.filePaths[0])}catch(o){t.error("选择目录失败"),console.error("选择目录失败:",o)}}async function oe(){if(P.value){try{await P.value.validate()}catch{return}f.value=!0;try{if(d.value)try{await q.confirm("Aria2 服务正在运行中。保存配置需要重启服务以应用新配置，是否继续？","确认保存配置",{confirmButtonText:"保存并重启",cancelButtonText:"取消",type:"warning"}),await x(i)&&(t.success("配置已保存，正在重启服务..."),await B())}catch{t.info("已取消保存配置");return}else await x(i)&&t.success("配置已保存")}catch(o){const e=o instanceof Error?o.message:String(o);console.error("保存配置失败:",o),e.includes("下载目录验证失败")?t.error("下载目录无效，请检查路径是否正确且具有写入权限"):e.includes("启动失败")?t.error("服务重启失败，请检查配置是否正确"):t.error(`保存配置失败: ${e}`)}finally{f.value=!1}}}function ae(){Object.assign(i,{port:6800,secret:"",downloadDir:"D:/Downloads/Aria2Downloads",autoStart:!0}),t.success("配置已重置")}async function ne(){if(!d.value){t.warning("请先启动本地 Aria2 服务");return}A.value=!0;try{const o=E.value;console.log("尝试连接配置:",{host:o.host,port:o.port,protocol:o.protocol,secret:o.secret?"***":"(无密钥)"}),c.updateConfig({host:o.host,port:o.port,protocol:o.protocol,secret:o.secret}),await c.connect(),t.success("已连接到本地 Aria2 服务")}catch(o){const e=o instanceof Error?o.message:String(o);t.error(`连接到本地服务失败: ${e}`),console.error("连接失败详情:",o),console.error("连接配置:",E.value)}finally{A.value=!1}}function se(){try{c.disconnect(),t.success("已断开与 Aria2 服务的连接")}catch(o){t.error("断开连接失败"),console.error("断开连接失败:",o)}}function O(){I().then(()=>{u.value.config?(i.port=u.value.config.port,i.secret=u.value.config.secret,i.autoStart=u.value.config.autoStart,i.downloadDir=u.value.config.downloadDir,console.log("processInfo.value:",u.value),console.log("processInfo.value.config:",u.value.config),console.log("从后端获取的完整配置:",u.value.config),console.log("设置到UI的配置:",{port:i.port,downloadDir:i.downloadDir,secret:i.secret,autoStart:i.autoStart})):Object.assign(i,{port:6800,secret:"",downloadDir:"D:/Downloads/Aria2Downloads",autoStart:!0})})}return Q(async()=>{p.value&&(await I(),O(),console.log("页面初始化完成，当前配置:",i))}),(o,e)=>{const V=g("el-icon"),C=g("el-button"),G=g("el-tag"),W=g("el-space"),L=g("el-card"),le=g("el-input-number"),h=g("el-form-item"),H=g("el-input"),ie=g("el-switch"),ue=g("el-form"),J=g("el-alert");return y(),j("div",Se,[e[26]||(e[26]=l("div",{class:"settings-header"},[l("h2",null,"本地 Aria2 服务"),l("p",{class:"settings-description"},"管理内置的 Aria2 服务，让小白用户也能轻松使用")],-1)),a(L,{class:"status-card"},{header:n(()=>[l("div",Ce,[e[6]||(e[6]=l("span",{class:"header-title"},"服务状态",-1)),a(C,{size:"small",onClick:Y,loading:r.value,circle:""},{default:n(()=>[a(V,null,{default:n(()=>[a(s(K))]),_:1})]),_:1},8,["loading"])])]),default:n(()=>[l("div",be,[l("div",De,[e[7]||(e[7]=l("span",{class:"status-label"},"运行状态：",-1)),a(G,{type:s(d)?"success":"danger",size:"large"},{default:n(()=>[_(R(s(d)?"运行中":"已停止"),1)]),_:1},8,["type"])]),s(k)?(y(),j("div",ke,[e[8]||(e[8]=l("span",{class:"status-label"},"错误信息：",-1)),a(G,{type:"danger"},{default:n(()=>[_(R(s(u).error),1)]),_:1})])):M("",!0)]),l("div",Ie,[a(W,{size:"large"},{default:n(()=>[a(C,{type:s(d)?"danger":"primary",onClick:e[0]||(e[0]=m=>s(d)?ee():Z()),loading:s($)||s(v),disabled:!s(T)&&!s(U)},{default:n(()=>[a(V,null,{default:n(()=>[s(d)?(y(),D(s(ve),{key:1})):(y(),D(s(ge),{key:0}))]),_:1}),_(" "+R(s(d)?"停止":"启动"),1)]),_:1},8,["type","loading","disabled"]),a(C,{type:"warning",onClick:re,loading:s($)||s(v),disabled:!s(N)},{default:n(()=>[a(V,null,{default:n(()=>[a(s(K))]),_:1}),e[9]||(e[9]=_(" 重启 ",-1))]),_:1},8,["loading","disabled"]),a(C,{type:s(c).isConnected?"warning":"success",onClick:e[1]||(e[1]=m=>s(c).isConnected?se():ne()),loading:A.value,disabled:!s(d)},{default:n(()=>[a(V,null,{default:n(()=>[s(c).isConnected?(y(),D(s(me),{key:1})):(y(),D(s(we),{key:0}))]),_:1}),_(" "+R(s(c).isConnected?"断开":"连接"),1)]),_:1},8,["type","loading","disabled"])]),_:1})])]),_:1}),a(L,{class:"config-card"},{header:n(()=>[...e[10]||(e[10]=[l("span",{class:"header-title"},"服务配置",-1)])]),default:n(()=>[a(ue,{ref_key:"configFormRef",ref:P,model:i,rules:X,"label-width":"150px",style:{"max-width":"600px"}},{default:n(()=>[a(h,{label:"监听端口",prop:"port"},{default:n(()=>[a(le,{modelValue:i.port,"onUpdate:modelValue":e[2]||(e[2]=m=>i.port=m),min:1024,max:65535,style:{width:"200px"}},null,8,["modelValue"]),e[11]||(e[11]=l("div",{class:"form-tip"},"Aria2 RPC 服务监听的端口号",-1))]),_:1}),a(h,{label:"访问密钥",prop:"secret"},{default:n(()=>[a(H,{modelValue:i.secret,"onUpdate:modelValue":e[3]||(e[3]=m=>i.secret=m),type:"password",placeholder:"留空则自动生成","show-password":"",clearable:""},null,8,["modelValue"]),e[12]||(e[12]=l("div",{class:"form-tip"},"RPC 接口的访问密钥，提高安全性",-1))]),_:1}),a(h,{label:"下载目录",prop:"downloadDir"},{default:n(()=>[a(H,{modelValue:i.downloadDir,"onUpdate:modelValue":e[4]||(e[4]=m=>i.downloadDir=m),placeholder:"留空使用默认目录"},{append:n(()=>[a(C,{onClick:te},{default:n(()=>[a(V,null,{default:n(()=>[a(s(ye))]),_:1}),e[13]||(e[13]=_(" 选择 ",-1))]),_:1})]),_:1},8,["modelValue"]),e[14]||(e[14]=l("div",{class:"form-tip"},"文件下载保存的默认目录",-1))]),_:1}),a(h,{label:"自动启动"},{default:n(()=>[a(ie,{modelValue:i.autoStart,"onUpdate:modelValue":e[5]||(e[5]=m=>i.autoStart=m)},null,8,["modelValue"]),e[15]||(e[15]=l("div",{class:"form-tip"},"应用启动时自动启动 Aria2 服务",-1))]),_:1}),a(h,null,{default:n(()=>[a(W,null,{default:n(()=>[a(C,{type:"primary",onClick:oe,loading:f.value},{default:n(()=>[...e[16]||(e[16]=[_(" 保存配置 ",-1)])]),_:1},8,["loading"]),a(C,{onClick:ae},{default:n(()=>[...e[17]||(e[17]=[_("重置配置",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),s(p)&&s(u).isAria2Available===!1?(y(),D(L,{key:0,class:"guide-card"},{header:n(()=>[...e[18]||(e[18]=[l("span",{class:"header-title"},"内置 Aria2 不可用",-1)])]),default:n(()=>[a(J,{title:"内置 Aria2 文件未找到",type:"warning",closable:!1,"show-icon":""},{default:n(()=>[e[21]||(e[21]=l("p",null,"应用中没有找到内置的 Aria2 可执行文件。",-1)),e[22]||(e[22]=l("p",null,[l("strong",null,"解决方案：")],-1)),e[23]||(e[23]=l("ol",null,[l("li",null,"请确保您下载的是完整版本的 Aria2Desktop"),l("li",null,"或者手动下载 Aria2 并将 aria2c.exe 放置到用户数据目录"),l("li",null,"也可以安装系统版本的 Aria2 并配置路径")],-1)),s(u).resourceInfo?(y(),j("p",xe,[e[19]||(e[19]=l("strong",null,"用户数据目录：",-1)),e[20]||(e[20]=l("br",null,null,-1)),l("code",null,R(s(u).resourceInfo.userDataPath),1)])):M("",!0)]),_:1})]),_:1})):M("",!0),s(p)?M("",!0):(y(),D(L,{key:1,class:"guide-card"},{header:n(()=>[...e[24]||(e[24]=[l("span",{class:"header-title"},"安装指南",-1)])]),default:n(()=>[a(J,{title:"本功能仅在桌面应用中可用",type:"info",closable:!1,"show-icon":""},{default:n(()=>[...e[25]||(e[25]=[l("p",null,"本地 Aria2 服务管理功能需要在 Electron 桌面应用中使用。",-1),l("p",null,"如果您正在使用 Web 版本，请下载桌面版应用以享受完整功能。",-1)])]),_:1})]),_:1}))])}}});const Ve=Ae(Ee,[["__scopeId","data-v-4888a1c4"]]);export{Ve as default};
