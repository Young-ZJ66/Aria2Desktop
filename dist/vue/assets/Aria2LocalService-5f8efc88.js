import{r as S,c as b,L as Q,R as de,E as o,d as fe,x as pe,a as ge,g as j,l,m as a,k as n,u as s,f as k,v as T,e as g,o as A,S as K,p as _,q as R,F as ve,G as we,T as me,U as ye,N as Ae,A as q,i as _e}from"./index-119c2593.js";function Se(){const w=S({isRunning:!1,pid:null,retryCount:0,config:null}),c=S(!1),u=S(!1),f=S(null),I=b(()=>w.value.isRunning),L=b(()=>!!w.value.error),U=b(()=>!I.value&&!c.value),N=b(()=>I.value&&!u.value),$=b(()=>!c.value&&!u.value),v=b(()=>typeof window<"u"&&window.electronAPI&&window.electronAPI.aria2);async function p(){if(!v.value){console.warn("Electron API not available");return}try{const t=await window.electronAPI.aria2.getStatus();w.value=t}catch(t){console.error("获取 Aria2 状态失败:",t),w.value.error=t instanceof Error?t.message:String(t)}}async function F(){if(!v.value)return o.error("Electron 环境不可用"),!1;if(c.value)return o.warning("Aria2 正在启动中，请稍候"),!1;c.value=!0;try{const t=await window.electronAPI.aria2.start();return t.success?(await p(),!0):(o.error(`启动 Aria2 失败: ${t.error}`),!1)}catch(t){const d=t instanceof Error?t.message:String(t);return o.error(`启动 Aria2 失败: ${d}`),console.error("启动 Aria2 失败:",t),!1}finally{c.value=!1}}async function z(){if(!v.value)return o.error("Electron 环境不可用"),!1;if(u.value)return o.warning("Aria2 正在停止中，请稍候"),!1;u.value=!0;try{const t=await window.electronAPI.aria2.stop();return t.success?(o.success("Aria2 已停止"),await p(),!0):(o.error(`停止 Aria2 失败: ${t.error}`),!1)}catch(t){const d=t instanceof Error?t.message:String(t);return o.error(`停止 Aria2 失败: ${d}`),console.error("停止 Aria2 失败:",t),!1}finally{u.value=!1}}async function B(){if(!v.value)return o.error("Electron 环境不可用"),!1;if(c.value||u.value)return o.warning("Aria2 正在操作中，请稍候"),!1;c.value=!0;try{const t=await window.electronAPI.aria2.restart();return t.success?(o.success("Aria2 重启成功"),await p(),!0):(o.error(`重启 Aria2 失败: ${t.error}`),!1)}catch(t){const d=t instanceof Error?t.message:String(t);return o.error(`重启 Aria2 失败: ${d}`),console.error("重启 Aria2 失败:",t),!1}finally{c.value=!1}}async function x(t){if(!v.value)return o.error("Electron 环境不可用"),!1;try{const d={port:t.port,secret:t.secret,downloadDir:t.downloadDir,autoStart:t.autoStart};console.log("正在更新 Aria2 配置:",d);const m=await window.electronAPI.aria2.updateConfig(d);return console.log("配置更新结果:",m),m.success?(await p(),console.log("配置更新成功，状态已刷新"),!0):(o.error(`更新 Aria2 配置失败: ${m.error}`),!1)}catch(d){const m=d instanceof Error?d.message:String(d);return o.error(`更新 Aria2 配置失败: ${m}`),console.error("更新 Aria2 配置失败:",d),!1}}function D(t=5e3){f.value&&clearInterval(f.value),f.value=setInterval(async()=>{await p()},t)}function E(){f.value&&(clearInterval(f.value),f.value=null)}const h=b(()=>w.value.config?{host:"localhost",port:w.value.config.port,protocol:"http",secret:w.value.config.secret}:{host:"localhost",port:6800,protocol:"http",secret:""});return Q(async()=>{v.value&&(await p(),D())}),de(()=>{E()}),{processInfo:w,isRunning:I,hasError:L,canStart:U,canStop:N,canRestart:$,isStarting:c,isStopping:u,isElectronAvailable:v,start:F,stop:z,restart:B,getStatus:p,updateConfig:x,startStatusCheck:D,stopStatusCheck:E,getConnectionConfig:h}}const Ce={class:"aria2-local-service"},be={class:"card-header"},De={class:"status-content"},ke={class:"status-row"},Ie={key:0,class:"status-row"},xe={class:"control-buttons"},Ee={key:0},he=fe({__name:"Aria2LocalService",setup(w){const c=pe(),{processInfo:u,isRunning:f,hasError:I,canStart:L,canStop:U,canRestart:N,isStarting:$,isStopping:v,isElectronAvailable:p,start:F,stop:z,restart:B,getStatus:x,updateConfig:D,getConnectionConfig:E}=Se(),h=S(),t=S(!1),d=S(!1),m=S(!1),i=ge({port:0,secret:"",downloadDir:"",autoStart:!1}),X={port:[{type:"number",min:1024,max:65535,message:"端口号必须在 1024-65535 之间",trigger:"blur"}]};async function Y(){t.value=!0;try{await x(),O(),o.success("状态已刷新")}catch{o.error("刷新状态失败")}finally{t.value=!1}}async function Z(){await F()&&(O(),o.success("Aria2 服务已启动"))}async function ee(){try{await q.confirm("确定要停止 Aria2 服务吗？这将中断所有正在进行的下载。","确认停止",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await z()}catch{}}async function te(){try{await q.confirm("确定要重启 Aria2 服务吗？这将暂时中断所有正在进行的下载。","确认重启",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await B()}catch{}}async function re(){if(!window.electronAPI){o.error("此功能仅在桌面应用中可用");return}try{const r=await window.electronAPI.showOpenDialog({title:"选择下载目录",properties:["openDirectory"],defaultPath:i.downloadDir});!r.canceled&&r.filePaths.length>0&&(i.downloadDir=r.filePaths[0])}catch(r){o.error("选择目录失败"),console.error("选择目录失败:",r)}}async function oe(){if(h.value){try{await h.value.validate()}catch{return}d.value=!0;try{if(f.value)try{await q.confirm("Aria2 服务正在运行中。保存配置需要重启服务以应用新配置，是否继续？","确认保存配置",{confirmButtonText:"保存并重启",cancelButtonText:"取消",type:"warning"}),await D(i)&&(o.success("配置已保存，正在重启服务..."),await B())}catch{o.info("已取消保存配置");return}else await D(i)&&o.success("配置已保存")}catch(r){const e=r instanceof Error?r.message:String(r);console.error("保存配置失败:",r),e.includes("下载目录验证失败")?o.error("下载目录无效，请检查路径是否正确且具有写入权限"):e.includes("启动失败")?o.error("服务重启失败，请检查配置是否正确"):o.error(`保存配置失败: ${e}`)}finally{d.value=!1}}}const ae=r=>{console.log("Auto-start changed to:",r),i.autoStart=r,D(i)};function ne(){Object.assign(i,{port:6800,secret:"",downloadDir:"D:/Downloads/Aria2Downloads",autoStart:!0}),o.success("配置已重置")}async function se(){if(!f.value){o.warning("请先启动本地 Aria2 服务");return}m.value=!0;try{const r=E.value;console.log("尝试连接配置:",{host:r.host,port:r.port,protocol:r.protocol,secret:r.secret?"***":"(无密钥)"}),c.updateConfig({host:r.host,port:r.port,protocol:r.protocol,secret:r.secret}),await c.connect(),o.success("已连接到本地 Aria2 服务")}catch(r){const e=r instanceof Error?r.message:String(r);o.error(`连接到本地服务失败: ${e}`),console.error("连接失败详情:",r),console.error("连接配置:",E.value)}finally{m.value=!1}}function le(){try{c.disconnect(),o.success("已断开与 Aria2 服务的连接")}catch(r){o.error("断开连接失败"),console.error("断开连接失败:",r)}}function O(){x().then(()=>{u.value.config?(i.port=u.value.config.port,i.secret=u.value.config.secret,i.autoStart=u.value.config.autoStart,i.downloadDir=u.value.config.downloadDir,console.log("processInfo.value:",u.value),console.log("processInfo.value.config:",u.value.config),console.log("从后端获取的完整配置:",u.value.config),console.log("设置到UI的配置:",{port:i.port,downloadDir:i.downloadDir,secret:i.secret,autoStart:i.autoStart})):Object.assign(i,{port:6800,secret:"",downloadDir:"D:/Downloads/Aria2Downloads",autoStart:!0})})}return Q(async()=>{p.value&&(await x(),O(),console.log("页面初始化完成，当前配置:",i))}),(r,e)=>{const P=g("el-icon"),C=g("el-button"),G=g("el-tag"),W=g("el-space"),M=g("el-card"),ie=g("el-input-number"),V=g("el-form-item"),H=g("el-input"),ue=g("el-switch"),ce=g("el-form"),J=g("el-alert");return A(),j("div",Ce,[e[26]||(e[26]=l("div",{class:"settings-header"},[l("h2",null,"本地 Aria2 服务"),l("p",{class:"settings-description"},"管理内置的 Aria2 服务，让小白用户也能轻松使用")],-1)),a(M,{class:"status-card"},{header:n(()=>[l("div",be,[e[6]||(e[6]=l("span",{class:"header-title"},"服务状态",-1)),a(C,{size:"small",onClick:Y,loading:t.value,circle:""},{default:n(()=>[a(P,null,{default:n(()=>[a(s(K))]),_:1})]),_:1},8,["loading"])])]),default:n(()=>[l("div",De,[l("div",ke,[e[7]||(e[7]=l("span",{class:"status-label"},"运行状态：",-1)),a(G,{type:s(f)?"success":"danger",size:"large"},{default:n(()=>[_(R(s(f)?"运行中":"已停止"),1)]),_:1},8,["type"])]),s(I)?(A(),j("div",Ie,[e[8]||(e[8]=l("span",{class:"status-label"},"错误信息：",-1)),a(G,{type:"danger"},{default:n(()=>[_(R(s(u).error),1)]),_:1})])):T("",!0)]),l("div",xe,[a(W,{size:"large"},{default:n(()=>[a(C,{type:s(f)?"danger":"primary",onClick:e[0]||(e[0]=y=>s(f)?ee():Z()),loading:s($)||s(v),disabled:!s(L)&&!s(U)},{default:n(()=>[a(P,null,{default:n(()=>[s(f)?(A(),k(s(we),{key:1})):(A(),k(s(ve),{key:0}))]),_:1}),_(" "+R(s(f)?"停止":"启动"),1)]),_:1},8,["type","loading","disabled"]),a(C,{type:"warning",onClick:te,loading:s($)||s(v),disabled:!s(N)},{default:n(()=>[a(P,null,{default:n(()=>[a(s(K))]),_:1}),e[9]||(e[9]=_(" 重启 ",-1))]),_:1},8,["loading","disabled"]),a(C,{type:s(c).isConnected?"warning":"success",onClick:e[1]||(e[1]=y=>s(c).isConnected?le():se()),loading:m.value,disabled:!s(f)},{default:n(()=>[a(P,null,{default:n(()=>[s(c).isConnected?(A(),k(s(ye),{key:1})):(A(),k(s(me),{key:0}))]),_:1}),_(" "+R(s(c).isConnected?"断开":"连接"),1)]),_:1},8,["type","loading","disabled"])]),_:1})])]),_:1}),a(M,{class:"config-card"},{header:n(()=>[...e[10]||(e[10]=[l("span",{class:"header-title"},"服务配置",-1)])]),default:n(()=>[a(ce,{ref_key:"configFormRef",ref:h,model:i,rules:X,"label-width":"150px",style:{"max-width":"600px"}},{default:n(()=>[a(V,{label:"监听端口",prop:"port"},{default:n(()=>[a(ie,{modelValue:i.port,"onUpdate:modelValue":e[2]||(e[2]=y=>i.port=y),min:1024,max:65535,style:{width:"200px"}},null,8,["modelValue"]),e[11]||(e[11]=l("div",{class:"form-tip"},"Aria2 RPC 服务监听的端口号",-1))]),_:1}),a(V,{label:"访问密钥",prop:"secret"},{default:n(()=>[a(H,{modelValue:i.secret,"onUpdate:modelValue":e[3]||(e[3]=y=>i.secret=y),type:"password",placeholder:"留空则自动生成","show-password":"",clearable:""},null,8,["modelValue"]),e[12]||(e[12]=l("div",{class:"form-tip"},"RPC 接口的访问密钥，提高安全性",-1))]),_:1}),a(V,{label:"下载目录",prop:"downloadDir"},{default:n(()=>[a(H,{modelValue:i.downloadDir,"onUpdate:modelValue":e[4]||(e[4]=y=>i.downloadDir=y),placeholder:"留空使用默认目录"},{append:n(()=>[a(C,{onClick:re},{default:n(()=>[a(P,null,{default:n(()=>[a(s(Ae))]),_:1}),e[13]||(e[13]=_(" 选择 ",-1))]),_:1})]),_:1},8,["modelValue"]),e[14]||(e[14]=l("div",{class:"form-tip"},"文件下载保存的默认目录",-1))]),_:1}),a(V,{label:"自动启动"},{default:n(()=>[a(ue,{modelValue:i.autoStart,"onUpdate:modelValue":e[5]||(e[5]=y=>i.autoStart=y),onChange:ae},null,8,["modelValue"]),e[15]||(e[15]=l("div",{class:"form-tip"},"应用启动时自动启动 Aria2 服务",-1))]),_:1}),a(V,null,{default:n(()=>[a(W,null,{default:n(()=>[a(C,{type:"primary",onClick:oe,loading:d.value},{default:n(()=>[...e[16]||(e[16]=[_(" 保存配置 ",-1)])]),_:1},8,["loading"]),a(C,{onClick:ne},{default:n(()=>[...e[17]||(e[17]=[_("重置配置",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),s(p)&&s(u).isAria2Available===!1?(A(),k(M,{key:0,class:"guide-card"},{header:n(()=>[...e[18]||(e[18]=[l("span",{class:"header-title"},"内置 Aria2 不可用",-1)])]),default:n(()=>[a(J,{title:"内置 Aria2 文件未找到",type:"warning",closable:!1,"show-icon":""},{default:n(()=>[e[21]||(e[21]=l("p",null,"应用中没有找到内置的 Aria2 可执行文件。",-1)),e[22]||(e[22]=l("p",null,[l("strong",null,"解决方案：")],-1)),e[23]||(e[23]=l("ol",null,[l("li",null,"请确保您下载的是完整版本的 Aria2Desktop"),l("li",null,"或者手动下载 Aria2 并将 aria2c.exe 放置到用户数据目录"),l("li",null,"也可以安装系统版本的 Aria2 并配置路径")],-1)),s(u).resourceInfo?(A(),j("p",Ee,[e[19]||(e[19]=l("strong",null,"用户数据目录：",-1)),e[20]||(e[20]=l("br",null,null,-1)),l("code",null,R(s(u).resourceInfo.userDataPath),1)])):T("",!0)]),_:1})]),_:1})):T("",!0),s(p)?T("",!0):(A(),k(M,{key:1,class:"guide-card"},{header:n(()=>[...e[24]||(e[24]=[l("span",{class:"header-title"},"安装指南",-1)])]),default:n(()=>[a(J,{title:"本功能仅在桌面应用中可用",type:"info",closable:!1,"show-icon":""},{default:n(()=>[...e[25]||(e[25]=[l("p",null,"本地 Aria2 服务管理功能需要在 Electron 桌面应用中使用。",-1),l("p",null,"如果您正在使用 Web 版本，请下载桌面版应用以享受完整功能。",-1)])]),_:1})]),_:1}))])}}});const Ve=_e(he,[["__scopeId","data-v-14fc5741"]]);export{Ve as default};
